<html>
    <head>
        <title>Billboard Time Travel Interface</title>
        <link rel="stylesheet" href="index.css">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <script type="text/javascript" src="./secret.js"></script> 
        <script>
            window.onload = function() { 
                login(function() {
                    iterate_playlists(when_i_have_everything)
                })
            }

            //  spotify green 84bd00
            // http://jsfiddle.net/JMPerez/62wafrm7/
            var access_header
            function login(callback) {
                let authorize = 'https://accounts.spotify.com/authorize?client_id=' + secrets.CLIENT_ID +
                    '&redirect_uri=' + encodeURIComponent(secrets.REDIRECT) +
                    '&scope=' + encodeURIComponent("playlist-modify-public") +
                    '&response_type=token';

                var width = 450,
                    height = 730,
                    left = (screen.width / 2) - (width / 2),
                    top = (screen.height / 2) - (height / 2);

                var w = window.open(authorize, "Spotify", 
                    'menubar=no,location=no,resizable=no,scrollbars=no,status=no, width=' + width 
                    + ', height=' + height + ', top=' + top + ', left=' + left)

                w.addEventListener("load", function() {
                    access_header = {
                        'Authorization': 'Bearer ' + w.location.hash.substr(1).split('&')[0].split("=")[1]
                    }

                    w.close()
                    callback()
                })
            }

            function iterate_playlists(callback) {
                getplaylists('https://api.spotify.com/v1/users/1246540326/playlists', [], callback)
            }

            function getplaylists(url, lists, callback) {
                return $.ajax({
                    url: url,
                    headers: access_header,                    
                }).then(function(response) {
                    lists = lists.concat(response.items)
                    if (response.next != null) {
                        return getplaylists(response.next, lists, callback)
                    } else {
                        return callback(lists)
                    }
                })
            }

            function when_i_have_everything(playlists) {
                let pop_docket = playlists.slice(
                    playlists.findIndex(function(x) {
                        return x.name == "POP-START"
                    }) + 1, 
                    playlists.findIndex(function(x) {
                        return x.name == "POP-END"
                    })
                )

                Promise.all(pop_docket.map(x => {
                    return $.ajax({
                        url: x.tracks.href,
                        headers: access_header
                    })
                })).then((results) => {
                    let box = document.querySelector("#appbox")
                    box.removeChild(document.querySelector(".loading"))
                    box.style.textAlign = "left";

                    let template = document.getElementById("albumtemp")
                        .content.querySelector("div")

                    pop_docket.forEach((x, i) => {    
                        let newAlbum = document.importNode(template, true)

                        let image = x.images[0]                    
                        let image_node = newAlbum.querySelector(".art").src = image.url
                        image_node.src = image.url

                        let [name, artist] = x.name.split("â€“")
                        newAlbum.querySelector(".name").innerText = name
                        newAlbum.querySelector(".artist").innerText = artist
                        newAlbum.querySelector(".year").innerText = results[i].items[0].track.album.release_date
                        
                        let duration_ms = results[i].items.reduce((a, b) => {
                            return a + b.track.duration_ms
                        }, 0)

                        newAlbum.querySelector(".length").innerText = 
                            results[i].items.length + " tracks / " + Math.round(duration_ms / 1000 / 60) + "m"

                        box.appendChild(newAlbum)
                    });
                })
            }
            
            function newalbums() {
                
            }

        </script>
    </head>
    <body>
        <template id="albumtemp">
            <div class="album">
                    <img class="art">
                    <div class="info">
                        <div class="name"></div>
                        <div class="artist"></div>
                        <div class="year"></div>
                        <div class="length"></div>
                    </div>
                </div>
        </template>

        <div id="appbox">
            <span class="loading">Loading...</span>
        </div>
    </body>
</html>